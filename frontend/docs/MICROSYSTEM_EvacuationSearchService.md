# MICROSYSTEM_EvacuationMapAndARViewService.md

## 🎯 目的

災害時、ユーザーの現在地と災害種別に応じて、安全な緊急避難所を自動抽出・表示し、地図上およびAR上で誘導を行う。初期段階では気象庁との自動連携なし。後の段階で危険度分析・物資情報も追加可能。

---

## 🗺 機能仕様（フェーズ1：初期実装）

### ✅ 地図＋現在地取得

- ユーザーの現在位置をGPSで取得
- 半径選択（1km〜10km、デフォルト3〜5km）
- 地図上に円（検索範囲）を描画（Google Maps API）

### ✅ 緊急避難所の抽出と表示

- 選択半径内で、対応する災害種別の避難所を抽出
- ポイント（マーカー）を地図上に表示
- 対応災害種別はドロップダウンで選択
  - 洪水、津波、地震、土砂、高潮、火山、火事、内水

### ✅ カード形式の一覧表示

- 地図下に避難所一覧をカード形式で表示（距離順）
- 各カードには以下を表示：
  - 名称、距離、標高、災害対応種別

### ✅ カード・ポイント連動

- カードをタップで該当マーカーが選択され、吹き出し表示
- 吹き出し内に「ルート案内」ボタン表示

### ✅ ルート案内（Google Directions API）

- 現在地 → 避難所までのルートをポリラインで表示
- 徒歩モードで案内

### ✅ AR表示連携

- 「AR表示」ボタンで `/ar` に遷移
- 選択中避難所の位置・名称をA-Frame + AR.jsで表示
- 現在位置から避難所までの方向・距離を表示
- 近づくと「到着」と表示（距離が一定以下）

---

## 🔜 フェーズ2：追加予定機能（後から追加）

### 🧭 自動災害種別選択（気象庁API連携）

- エリアに対して発令された警報・避難勧告内容をもとに災害種別を自動選択
- UI上で「自動選択」のON/OFF切替あり

### ⚠️ 危険度連携（ポリゴン × ルート）

- ルートと災害ポリゴン（洪水・津波等）を重ね、危険ルートを判定
- 危険エリアを赤で表示

### 📦 避難所詳細情報

- 混雑度（low / medium / high）
- 足りない物資（例：水、毛布、医薬品）
- 危険度（周囲の災害状況から算出）

---

## 🔗 データソース

### 使用テーブル（PostgreSQL）

- `emergency_shelters`：

  - 緯度・経度、対応災害、標高、住所、混雑度、物資情報

- `designated_shelters`（参照用）：
  - 通常の指定避難所、災害種別なし

---

## 📡 使用技術と連携

| 機能           | 使用技術                   |
| -------------- | -------------------------- |
| 地図・マーカー | Google Maps JavaScript API |
| 現在地取得     | Geolocation API            |
| ルート表示     | Google Directions API      |
| AR誘導         | A-Frame + AR.js + WebXR    |
| フロント       | React + Tailwind           |
| バックエンド   | Flask + PostgreSQL         |

---

## 🔧 APIエンドポイント

- `/api/search`: 災害種別 + 半径 + 現在地 → 対応避難所一覧
- `/api/route`: 避難所までの経路取得
- `/api/ar_target`: AR誘導用に選択避難所情報を受け渡し

---

## 🧪 テスト項目

| テスト項目                    | 結果 |
| ----------------------------- | ---- |
| 現在地からの距離計算          | ✅   |
| 半径内のマーカー正確に抽出    | ✅   |
| カード ⇔ マーカー 連動        | ✅   |
| 吹き出しにAR遷移ボタンあり    | ✅   |
| AR上に正確な距離・方向表示    | ✅   |
| 「到着」の条件判定（10m以内） | ✅   |

---

## 🚧 注意事項

- 災害種別が未入力の場合、検索不可
- 気象庁API連携や危険度判定機能は後日導入
- 現在は緊急避難所のみに絞って対象データを取得
